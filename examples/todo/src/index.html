<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Todo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: var(--ls-font-family);
      background: var(--ls-color-bg);
      color: var(--ls-color-text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    header {
      padding: 24px 24px 0;
    }
    header h1 {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    .summary {
      font-size: 13px;
      color: var(--ls-color-text-secondary);
      margin-top: 4px;
    }
    .input-row {
      display: flex;
      gap: 8px;
      padding: 16px 24px;
    }
    .input-row input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--ls-color-border);
      border-radius: 8px;
      background: var(--ls-color-surface);
      color: var(--ls-color-text);
      font-size: 14px;
      font-family: var(--ls-font-family);
      outline: none;
      transition: border-color 0.15s;
    }
    .input-row input:focus {
      border-color: var(--ls-color-accent);
    }
    .input-row input::placeholder {
      color: var(--ls-color-text-secondary);
    }
    .input-row button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: var(--ls-color-accent);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--ls-font-family);
      white-space: nowrap;
      transition: opacity 0.15s;
    }
    .input-row button:hover { opacity: 0.85; }
    .filter-bar {
      display: flex;
      gap: 4px;
      padding: 0 24px 12px;
    }
    .filter-bar button {
      padding: 5px 12px;
      border: 1px solid var(--ls-color-border);
      border-radius: 6px;
      background: transparent;
      color: var(--ls-color-text-secondary);
      font-size: 12px;
      cursor: pointer;
      font-family: var(--ls-font-family);
      transition: all 0.15s;
    }
    .filter-bar button.active {
      background: var(--ls-color-accent);
      color: #fff;
      border-color: var(--ls-color-accent);
    }
    .todo-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 24px 24px;
    }
    .todo-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--ls-color-border);
      animation: slideIn 0.2s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .todo-item .check {
      width: 20px;
      height: 20px;
      border: 2px solid var(--ls-color-border);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }
    .todo-item .check:hover {
      border-color: var(--ls-color-accent);
    }
    .todo-item.done .check {
      background: var(--ls-color-accent);
      border-color: var(--ls-color-accent);
    }
    .todo-item.done .check::after {
      content: '';
      width: 6px;
      height: 10px;
      border: solid #fff;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg) translate(-1px, -1px);
    }
    .todo-item .text {
      flex: 1;
      font-size: 14px;
      line-height: 1.4;
    }
    .todo-item.done .text {
      text-decoration: line-through;
      color: var(--ls-color-text-secondary);
    }
    .todo-item .delete {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--ls-color-text-secondary);
      font-size: 18px;
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.15s;
    }
    .todo-item:hover .delete { opacity: 1; }
    .todo-item .delete:hover {
      background: light-dark(#fee, #3a2020);
      color: light-dark(#c44, #f66);
    }
    .empty {
      text-align: center;
      padding: 48px 0;
      color: var(--ls-color-text-secondary);
      font-size: 14px;
    }
    .shortcut-hint {
      font-size: 11px;
      color: var(--ls-color-text-secondary);
      text-align: center;
      padding: 8px;
      border-top: 1px solid var(--ls-color-border);
    }
    .shortcut-hint kbd {
      font-family: var(--ls-font-mono);
      background: var(--ls-color-surface);
      padding: 1px 5px;
      border-radius: 3px;
      border: 1px solid var(--ls-color-border);
      font-size: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Todo</h1>
    <div class="summary" id="summary">0 tasks</div>
  </header>

  <div class="input-row">
    <input type="text" id="input" placeholder="What needs to be done?" autofocus>
    <button id="btn-add">Add</button>
  </div>

  <div class="filter-bar">
    <button class="active" data-filter="all">All</button>
    <button data-filter="active">Active</button>
    <button data-filter="done">Done</button>
  </div>

  <div class="todo-list" id="list"></div>

  <div class="shortcut-hint">
    <kbd>Cmd+N</kbd> / <kbd>Ctrl+N</kbd> to add new todo
  </div>

  <script>
    // -- State --
    let todos = []
    let filter = 'all'
    const STORE_KEY = 'todos'

    // -- DOM refs --
    const input = document.getElementById('input')
    const list = document.getElementById('list')
    const summary = document.getElementById('summary')

    // -- Persistence with lightshell.store --
    async function loadTodos() {
      // Retrieve persisted todos from the key-value store
      const saved = await lightshell.store.get(STORE_KEY)
      if (saved) todos = saved
      render()
    }

    async function saveTodos() {
      // Persist the full todo array to the key-value store
      await lightshell.store.set(STORE_KEY, todos)
      updateExtras()
    }

    // -- Update tray, badge, and window title --
    async function updateExtras() {
      const active = todos.filter(t => !t.done).length
      const total = todos.length

      // Update window title to show count
      await lightshell.window.setTitle(`Todo (${active} remaining)`)

      // Set macOS dock badge to active task count (0 clears badge)
      await lightshell.app.setBadgeCount(active)

      // Set system tray with task count
      await lightshell.tray.set({
        title: `${active}/${total}`,
        menu: [
          { label: `${active} active, ${total - active} done`, disabled: true },
          { type: 'separator' },
          { label: 'Show Window', click: () => lightshell.window.restore() },
          { label: 'Quit', click: () => lightshell.app.quit() }
        ]
      })

      // Update summary text
      summary.textContent = `${total} task${total !== 1 ? 's' : ''} \u00b7 ${active} active`
    }

    // -- Core actions --
    function addTodo(text) {
      if (!text.trim()) return
      todos.unshift({ id: Date.now(), text: text.trim(), done: false })
      saveTodos()
      render()
    }

    function toggleTodo(id) {
      const t = todos.find(t => t.id === id)
      if (t) t.done = !t.done
      saveTodos()
      render()
    }

    function deleteTodo(id) {
      todos = todos.filter(t => t.id !== id)
      saveTodos()
      render()
    }

    // -- Rendering --
    function render() {
      const filtered = todos.filter(t => {
        if (filter === 'active') return !t.done
        if (filter === 'done') return t.done
        return true
      })

      if (filtered.length === 0) {
        const msg = filter === 'all' ? 'No todos yet. Add one above.'
          : filter === 'active' ? 'All caught up!' : 'Nothing completed yet.'
        list.innerHTML = `<div class="empty">${msg}</div>`
        return
      }

      list.innerHTML = filtered.map(t => `
        <div class="todo-item ${t.done ? 'done' : ''}" data-id="${t.id}">
          <div class="check" onclick="toggleTodo(${t.id})"></div>
          <span class="text">${escapeHtml(t.text)}</span>
          <button class="delete" onclick="deleteTodo(${t.id})">\u00d7</button>
        </div>
      `).join('')
    }

    function escapeHtml(s) {
      const d = document.createElement('div')
      d.textContent = s
      return d.innerHTML
    }

    // -- Event listeners --
    document.getElementById('btn-add').addEventListener('click', () => {
      addTodo(input.value)
      input.value = ''
      input.focus()
    })

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        addTodo(input.value)
        input.value = ''
      }
    })

    // Filter buttons
    document.querySelector('.filter-bar').addEventListener('click', (e) => {
      if (e.target.dataset.filter) {
        filter = e.target.dataset.filter
        document.querySelectorAll('.filter-bar button').forEach(b => b.classList.remove('active'))
        e.target.classList.add('active')
        render()
      }
    })

    // -- Global keyboard shortcut via lightshell.shortcuts --
    // Register Cmd+N (macOS) / Ctrl+N (Linux) as global hotkey to focus input
    lightshell.shortcuts.register('CommandOrControl+N', () => {
      // Restore and focus the window, then focus the input
      lightshell.window.restore()
      input.focus()
      input.select()
    })

    // -- Initialize --
    loadTodos()
  </script>
</body>
</html>
