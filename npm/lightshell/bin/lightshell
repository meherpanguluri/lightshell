#!/usr/bin/env node

// This shim finds the platform-specific binary and executes it.
// The actual binary lives in @lightshell/{platform} optional dependency.

const { platform, arch } = process;
const { execFileSync } = require("child_process");
const path = require("path");

const platformMap = { darwin: "darwin", linux: "linux" };
const archMap = { arm64: "arm64", x64: "x64", x86_64: "x64" };

const os = platformMap[platform];
const cpu = archMap[arch];

if (!os || !cpu) {
  console.error(
    `lightshell: unsupported platform ${platform}-${cpu || arch}. Only macOS and Linux (arm64, x64) are supported.`
  );
  process.exit(1);
}

const pkgName = `@lightshell/${os}-${cpu}`;

let binaryPath;
try {
  binaryPath = require.resolve(`${pkgName}/lightshell`);
} catch {
  console.error(
    `lightshell: could not find ${pkgName}.\n` +
      `This usually means optional dependencies were not installed.\n` +
      `Try: npm install @lightshell/cli --include=optional`
  );
  process.exit(1);
}

try {
  const result = execFileSync(binaryPath, process.argv.slice(2), {
    stdio: "inherit",
    env: process.env,
  });
} catch (err) {
  if (err.status !== null) {
    process.exit(err.status);
  }
  console.error(`lightshell: failed to run binary: ${err.message}`);
  process.exit(1);
}
